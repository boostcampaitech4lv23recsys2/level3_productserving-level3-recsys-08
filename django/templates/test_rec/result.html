{% extends 'test_rec/base.html' %}
{% load static %} 
{% block contents %}
<div class="result_wrap">
    <div class="container_result">
      <div class="nav_result">
        <div class="nav_result_box">
          <a href="#mbti" class="nav_result_li">ë‚˜ì™€ ë¹„ìŠ·í•œ ìºë¦­í„°</a>
          <a href="#attractive" class="nav_result_li">ë§¤ë ¥ì ì¸ ìºë¦­í„°</a>
        </div>
      </div>
      <div class="header_result">
        <div class="contents_header">
          <h3 class="contents_header_title">MVTI</h3>
          <h2 class="contents_header_subtitle">ëª‡ ê°œê³ ? ë‚´ ë‹®ì€ ìºë¦­í„° ë§ì´ë‹¤.</h2>
          <div class="container_header_bar"></div>
        </div>
        {% comment %} <img class="header_image" src="https://images.unsplash.com/photo-1478720568477-152d9b164e26?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" alt="film" /> {% endcomment %}
      </div>
      <div class="background_wrap">
        <div class="contents_result">
            <div class="character">
              <img
                src="/static/img/mbti/{{ tmpuser.MBTI }}.png"
                alt="Responsive image"
                class="character_image"
                style="grid-column: 1 / 2; margin: auto; width:auto; max-width: 250px; max-height:340px;"
              />
              <div class="result_character_info">
                <div class="character_info" style="margin-bottom:3px">ì„ íƒí•œ MBTI: {{ tmpuser.MBTI }}</div>
                <div class="character_info" style="margin-bottom:6px">ì„¤ë¬¸ì„ í†µí•œ ì„±ê²©</div>
                <ul>
                  <li style="margin-bottom:8px">{{ user_tag }}</li>
                  {% for description in user_desc %}
                    <li style="margin-bottom:5px">- {{ description }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <div class="cards_box_container">
              <div class="cards_box">
                <div class="cards_category">
                  <div id="mbti" class="cards_category_text">ë‚˜ì™€ ë¹„ìŠ·í•œ ìºë¦­í„°</div>
                </div>
                {% for character in data1 %}
                  <div id="data1" class="character_card" onclick="location.href='/test_rec/{{character.CharacterId}}'">
                    <img
                      src="{{ character.img_src }}"
                      class="card_image"
                      alt="Responsive image"
                    />
                    <div class="card_body">
                      <div class="card_title">{{ character.name }}</div>
                      <div class="card_info" data-sim="{{character.Enneagram_sim}}">
                        <div class="card_info_items">
                          <div class="card_info_items_box">
                            <div class="card_info_item">
                              <span class="card_info_item_title">{{character.ko_title}}</span>
                            </div>
                            <div class="card_info_item">
                              <span class="card_info_item_title">MBTI | {{ character.MBTI }}</span>
                            </div>
                          </div>
                          <div class="card_info_item">
                            <span class="card_info_item_tag">{{ character.hashtag }}</span>
                          </div>
                        </div>
                        <div class="card_info_text_box">
                          <h6 class="card_info_text">ìœ ì‚¬ë„</h6>
                          <h6 class="card_info_text">{{character.Enneagram_sim}} %</h6>
                        </div>
                        <progress id="progress" value="{{character.Enneagram_sim}}" min="0" max="100"></progress>
                      </div>
                      
                    </div>
                  </div>
                {% endfor %}
                  
                <div class="cards_category category_color">
                  <div id="attractive" class="cards_category_text">ë‚˜ì™€ ê¶í•©ì´ ì˜ë§ëŠ” ìºë¦­í„°</div>
                </div>
                {% for character in data2 %}
                  <div id="data2" class="character_card" onclick="location.href='/test_rec/{{character.CharacterId}}'">
                    <img
                      src="{{ character.img_src }}"
                      class="card_image"
                      alt="Responsive image"
                    />
                    <div class="card_body">
                      <div class="card_title">{{ character.name }}</div>
                      <div class="card_info" data-sim="{{character.Enneagram_sim}}">
                        <div class="card_info_items">
                          <div class="card_info_item">
                            <span class="card_info_item_title">{{character.ko_title}}</span>
                            
                          </div>
                          <div class="card_info_item">
                            <span class="card_info_item_title">MBTI | {{ character.MBTI }}</span>
                            
                          </div>
                          <div class="card_info_item">
                            <span class="card_info_item_tag">{{ character.hashtag }}</span>
                            
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            
        </div>
      </div>
    </div>
    
    <div class="button_group">
      
      <div class="feedback_box" data_user="{{tmpuser}}" data_loginUser="{{tmpuser.LoginUser_id}}">
        <!-- ì´ë¯¸ í”¼ë“œë°±ì„ í–ˆì„ë•Œ -->  
        {% if feedback %}
        <button class="feedback left" value="+" > 
          {% if feedback == '+' %}
            <i id="thumbs_up" class="fa-solid fa-thumbs-up"></i>
          {% elif feedback == '-' %}
            <i id="thumbs_up" class="fa-regular fa-thumbs-up"></i>
          {% endif %}
        </button>
        <div class="divider"></div>
        <button class="feedback right" value="-">
          {% if feedback == '+' %}
            <i id="thumbs_down" class="fa-regular fa-thumbs-down"></i>
          {% elif feedback == '-' %}
            <i id="thumbs_down" class="fa-solid fa-thumbs-down"></i>
          {% endif %}
        </button>
        <!-- í”¼ë“œë°±ì„ ì•ˆí–ˆì„ë•Œ -->
        {% else %}
        <button class="feedback left" value="+">
          <i id="thumbs_up" class="fa-regular fa-thumbs-up"></i>
        </button>
        <span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì— ë“œì‹œë‚˜ìš”?</span>
        <button class="feedback right" value="-">
          <i id="thumbs_down" class="fa-regular fa-thumbs-down"></i>
        </button>
        {% endif %}  
      </div>
      <button class="retest_button" >
        <a href="/test_rec/start_test" class="result_button">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</a>
      </button>
      <button class="retest_button" >
        <a class="result_button" id="kakaotalk-sharing-btn" href="javascript:;" >ì¹´ì¹´ì˜¤í†¡ ê³µìœ í•˜ê¸°</a>
      </button>
      <button class="retest_button"  onclick="copyLink()">
        <a class="result_button" href="#">ë§í¬ ê³µìœ í•˜ê¸°</a>
      </button>
    </div>
    
    <a href="#">
      <div class="button_top" style="bottom: 115px">
        <i class="fa-solid fa-arrow-up"></i>
      </div>
    </a>
</div>

<div id="jsvariable" tmpuser_id="{{tmpuser.id}}"></div>
<script>
  function giveFeedback(url, value){
    $.ajax({
      type: 'POST',
      url: url,
      data: {
        'value':value
      },
      success: function (response) {
        setTimeout(() => {
          console.log('response',response)
        }, 500)
      },
      error: function (error) {
        setTimeout(() => {
          $('.wrap').innerHTML = `failed to load the data`
        }, 5000)
      }
    }).done((response) => {
      console.log('feedback ì™„ë£Œ')
    })
  }

  function toggle(value){
    if(value == '+'){
      $('#thumbs_up').toggleClass('fa-regular fa-solid')
    }else if(value == '-'){
      $('#thumbs_down').toggleClass('fa-regular fa-solid')
    }
  }
  function toggleAll(){
    $('#thumbs_up').toggleClass('fa-regular fa-solid')
    $('#thumbs_down').toggleClass('fa-regular fa-solid')

  }
  
  $('.feedback').click(function(event){
    // event.preventDefault();
    let userId = $('.feedback_box').attr('data_user')
    let url = '/test_rec/feedback/' + userId
    let value = event.currentTarget.value
    let chosen = $('.chosen')
    console.log('chosen.value', chosen.val())
    if(chosen.val() === undefined){
      // ì„ íƒì•ˆí•œ ìƒíƒœ
      console.log("ë‘˜ë‹¤ ì„ íƒ ì•ˆëœ ìƒíƒœ")
      $('.feedback_text').remove();
      toggle(value)
      if(value == '+'){
        $('.left').after('<span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì—ë“¤ì–´ìš”</span>')
        $('.feedback_text').after('<div class="divider"></div>')
        $('.left').toggleClass('chosen')
      }else if(value == '-'){
        $('.right').before('<span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì— ì•ˆë“¤ì–´ìš”</span>')
        $('.feedback_text').before('<div class="divider"></div>')
        $('.right').toggleClass('chosen')
      }
    }else{
      console.log("ë‘˜ ì¤‘ í•˜ë‚˜ ì„ íƒ")
      if(chosen.val() == value){
        console.log('chosen',chosen.val())
        console.log("ì„ íƒ ëœì• ë¥¼ í•´ì œ")
        // ì„ íƒí•œê±° ë„ê¸° -> ì„ íƒì•ˆí•œ ìƒíƒœ
        toggle(value);
        $('.feedback_text').remove();
        $('.divider').remove();
        $('.left').after('<span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì— ë“œì‹œë‚˜ìš”?</span>')
        chosen.removeClass('chosen')
      }else{
        console.log("ì„ íƒ ëœ ë°˜ëŒ€í¸ ëˆ„ë¥¸ ê²½ìš°")
        // ì´ë¯¸ ì„ íƒí•˜ê³  ì„ íƒë°”ê¾¸ê¸°
        toggleAll()
        $('.divider').remove();
        $('.feedback_text').remove();
        chosen.removeClass('chosen')
        if(value == '+'){
          $('.left').after('<span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì—ë“¤ì–´ìš”</span>')
          $('.feedback_text').after('<div class="divider"></div>')
          $('.left').toggleClass('chosen')
        }else if(value == '-'){
          $('.right').before('<span class="feedback_text">ì¶”ì²œê²°ê³¼ê°€ ë§˜ì— ì•ˆë“¤ì–´ìš”</span>')
          $('.feedback_text').before('<div class="divider"></div>')
          $('.right').toggleClass('chosen')   
        }
      }
    }
    giveFeedback(url, value)  
  })

  var variable = document.getElementById('jsvariable'); // ì„ì‹œë¡œ ë§Œë“  ë³€ìˆ˜ë¥¼ ë‹´ì„ div
  tmpuser_id = variable.getAttribute('tmpuser_id'); // ì„ì‹œë¡œ ë§Œë“  ë³€ìˆ˜ì˜ tmpuser_id ì†ì„±ì„ ê°€ì ¸ì˜´
      
  function copyLink() {
    const shareURL = 'https://www.ì¸ìƒìºë¦­í„°.com/common/share_tmpuser/'+tmpuser_id;
    navigator.clipboard.writeText(shareURL).then(function() {
      alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!ğŸ¥°");
    }, function(err) {
      console.error("ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", err);
    });
  }
</script>
{% endblock %}
